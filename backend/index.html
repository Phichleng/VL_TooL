<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast Hand Video - Enhanced</title>
    
    <!-- React and dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Socket.IO for real-time updates -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <style>
        /* Enhanced scrollbar for downloads sidebar */
        .download-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .download-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .download-scroll::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .download-scroll::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Enhanced pulse animation */
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        /* Progress bar with moving stripes */
        @keyframes progressStripes {
            0% { background-position: 0 0; }
            100% { background-position: 40px 0; }
        }
        
        .progress-active {
            background-image: linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0.2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 40px 40px;
            animation: progressStripes 1s linear infinite;
        }
        
        /* Connection status indicator */
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .connection-connected {
            background-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
            animation: pulse 2s infinite;
        }
        
        .connection-disconnected {
            background-color: #ef4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3);
        }
        
        /* Download item hover effects */
        .download-item {
            transition: all 0.2s ease;
        }
        
        .download-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* Status indicator glow effects */
        .status-downloading {
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.4);
        }
        
        .status-completed {
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
        }
        
        .status-error {
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Enhanced React Application -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const VideoDownloaderUI = () => {
          // WebSocket connection
          const [socket, setSocket] = useState(null);
          const [connectionStatus, setConnectionStatus] = useState('disconnected');
          const reconnectTimeoutRef = useRef(null);
          
          // UI State
          const [activeTab, setActiveTab] = useState('single');
          const [downloads, setDownloads] = useState([]);
          const [isProcessing, setIsProcessing] = useState(false);
          const [settings, setSettings] = useState({
            download_path: './downloads',
            remove_watermarks: false,
            ffmpeg_available: false
          });

          // Form states
          const [singleUrl, setSingleUrl] = useState('');
          const [customFilename, setCustomFilename] = useState('');
          const [removeWatermarkSingle, setRemoveWatermarkSingle] = useState(false);
          const [batchUrls, setBatchUrls] = useState('');
          const [profileUrl, setProfileUrl] = useState('');
          const [maxVideos, setMaxVideos] = useState('');
          const [webpageUrl, setWebpageUrl] = useState('');
          const [maxWebpageVideos, setMaxWebpageVideos] = useState('10');
          const [infoUrl, setInfoUrl] = useState('');
          const [videoInfo, setVideoInfo] = useState(null);

          // Backend API base URL
          const API_BASE = `${window.location.protocol}//${window.location.host}/api`;

          // Enhanced WebSocket connection with auto-reconnect
          const connectSocket = useCallback(() => {
            console.log('Attempting to connect to server...');
            
            const newSocket = io(window.location.origin, {
              transports: ['websocket', 'polling'],
              reconnection: true,
              reconnectionAttempts: 10,
              reconnectionDelay: 1000,
              reconnectionDelayMax: 5000,
              timeout: 20000
            });
            
            // Connection events
            newSocket.on('connect', () => {
              console.log('Connected to server');
              setConnectionStatus('connected');
              setSocket(newSocket);
              
              // Clear any pending reconnection timeout
              if (reconnectTimeoutRef.current) {
                clearTimeout(reconnectTimeoutRef.current);
                reconnectTimeoutRef.current = null;
              }
              
              // Request current downloads
              newSocket.emit('get_downloads');
            });

            newSocket.on('disconnect', (reason) => {
              console.log('Disconnected from server:', reason);
              setConnectionStatus('disconnected');
              
              // Attempt reconnection after delay
              if (!reconnectTimeoutRef.current) {
                reconnectTimeoutRef.current = setTimeout(() => {
                  console.log('Attempting to reconnect...');
                  connectSocket();
                }, 3000);
              }
            });
            
            newSocket.on('connect_error', (error) => {
              console.error('Connection error:', error);
              setConnectionStatus('error');
            });

            // Enhanced progress event listeners
            newSocket.on('download_progress', (data) => {
              console.log('Progress update:', data);
              updateDownloadProgress(data.id, data);
            });

            newSocket.on('download_status', (data) => {
              console.log('Status update:', data);
              updateDownloadStatus(data.id, data);
            });

            newSocket.on('batch_progress', (data) => {
              console.log('Batch progress:', data);
              updateBatchProgress(data);
            });

            newSocket.on('downloads_update', (data) => {
              console.log('Downloads sync:', data);
              if (data.downloads) {
                setDownloads(data.downloads);
              }
            });

            newSocket.on('downloads_cleared', () => {
              console.log('Downloads cleared');
              setDownloads(prev => prev.filter(d => 
                ['queued', 'starting', 'downloading', 'extracting', 'extracting_links', 'extracting_profile'].includes(d.status)
              ));
            });

            return newSocket;
          }, []);

          // Initialize connection on mount
          useEffect(() => {
            const newSocket = connectSocket();
            loadSettings();
            
            return () => {
              if (reconnectTimeoutRef.current) {
                clearTimeout(reconnectTimeoutRef.current);
              }
              if (newSocket) {
                newSocket.close();
              }
            };
          }, [connectSocket]);

          const loadSettings = async () => {
            try {
              const response = await fetch(`${API_BASE}/settings`);
              if (response.ok) {
                const data = await response.json();
                setSettings(data);
              }
            } catch (error) {
              console.error('Failed to load settings:', error);
            }
          };

          // Enhanced download update functions
          const updateDownloadProgress = (id, progressData) => {
            setDownloads(prev => prev.map(download => {
              if (download.id === id) {
                return {
                  ...download,
                  ...progressData,
                  last_update: Date.now()
                };
              }
              return download;
            }));
          };

          const updateDownloadStatus = (id, statusData) => {
            setDownloads(prev => prev.map(download => {
              if (download.id === id) {
                return {
                  ...download,
                  ...statusData,
                  last_update: Date.now()
                };
              }
              return download;
            }));
          };

          const updateBatchProgress = (batchData) => {
            // Update downloads with batch information
            setDownloads(prev => prev.map(download => {
              if (download.batch_id === batchData.batch_id) {
                return {
                  ...download,
                  batch_current: batchData.current,
                  batch_total: batchData.total,
                  current_url: batchData.url
                };
              }
              return download;
            }));
          };

          const detectPlatform = (url) => {
            try {
              const domain = new URL(url).hostname.toLowerCase();
              
              const platforms = {
                'tiktok': ['tiktok.com', 'vm.tiktok.com'],
                'douyin': ['douyin.com', 'v.douyin.com'],
                'youtube': ['youtube.com', 'youtu.be', 'm.youtube.com'],
                'facebook': ['facebook.com', 'fb.watch', 'm.facebook.com'],
                'instagram': ['instagram.com', 'instagr.am']
              };

              for (const [platform, domains] of Object.entries(platforms)) {
                if (domains.some(d => domain.includes(d))) {
                  return platform;
                }
              }
              return 'unknown';
            } catch {
              return 'unknown';
            }
          };

          const addDownloadToUI = (downloadId, url, type = 'single', batchId = null, batchIndex = null, batchTotal = null) => {
            const newDownload = {
              id: downloadId,
              url: url,
              platform: detectPlatform(url),
              status: 'queued',
              progress: 0,
              percentage: 0,
              type: type,
              created_at: new Date().toISOString(),
              batch_id: batchId,
              batch_index: batchIndex,
              batch_total: batchTotal,
              downloaded_bytes: 0,
              total_bytes: 0,
              speed: 0,
              eta: 0,
              filename: '',
              last_update: Date.now()
            };
            
            setDownloads(prev => [newDownload, ...prev]);
            return newDownload;
          };

          // Enhanced API call functions
          const handleSingleDownload = async () => {
            if (!singleUrl.trim()) return;
            
            setIsProcessing(true);
            
            try {
              const response = await fetch(`${API_BASE}/download/single`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  url: singleUrl,
                  custom_filename: customFilename || undefined,
                  remove_watermark: removeWatermarkSingle
                })
              });

              const result = await response.json();
              
              if (response.ok) {
                addDownloadToUI(result.download_id, singleUrl, 'single');
                setSingleUrl('');
                setCustomFilename('');
                console.log('Single download started:', result.download_id);
              } else {
                alert('Error: ' + result.error);
              }
            } catch (error) {
              alert('Connection error: ' + error.message);
            }
            
            setIsProcessing(false);
          };

          const handleBatchDownload = async () => {
            if (!batchUrls.trim()) return;
            
            setIsProcessing(true);
            const urls = batchUrls.split('\n').filter(url => url.trim());
            
            try {
              const response = await fetch(`${API_BASE}/download/batch`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  urls: urls,
                  remove_watermark: settings.remove_watermarks
                })
              });

              const result = await response.json();
              
              if (response.ok) {
                // Batch downloads will be added via WebSocket events
                setBatchUrls('');
                console.log('Batch download started:', result.batch_id);
              } else {
                alert('Error: ' + result.error);
              }
            } catch (error) {
              alert('Connection error: ' + error.message);
            }
            
            setIsProcessing(false);
          };

          const handleProfileDownload = async () => {
            if (!profileUrl.trim()) return;
            
            setIsProcessing(true);
            
            try {
              const response = await fetch(`${API_BASE}/download/profile`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  profile_url: profileUrl,
                  max_videos: maxVideos ? parseInt(maxVideos) : undefined,
                  remove_watermark: settings.remove_watermarks
                })
              });

              const result = await response.json();
              
              if (response.ok) {
                addDownloadToUI(result.download_id, profileUrl, 'profile');
                setProfileUrl('');
                setMaxVideos('');
                console.log('Profile download started:', result.download_id);
              } else {
                alert('Error: ' + result.error);
              }
            } catch (error) {
              alert('Connection error: ' + error.message);
            }
            
            setIsProcessing(false);
          };

          const handleWebpageDownload = async () => {
            if (!webpageUrl.trim()) return;
            
            setIsProcessing(true);
            
            try {
              const response = await fetch(`${API_BASE}/download/webpage`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  webpage_url: webpageUrl,
                  max_videos: parseInt(maxWebpageVideos),
                  remove_watermark: settings.remove_watermarks
                })
              });

              const result = await response.json();
              
              if (response.ok) {
                addDownloadToUI(result.download_id, webpageUrl, 'webpage');
                setWebpageUrl('');
                console.log('Webpage download started:', result.download_id);
              } else {
                alert('Error: ' + result.error);
              }
            } catch (error) {
              alert('Connection error: ' + error.message);
            }
            
            setIsProcessing(false);
          };

          const handleGetVideoInfo = async () => {
            if (!infoUrl.trim()) return;
            
            setIsProcessing(true);
            
            try {
              const response = await fetch(`${API_BASE}/video-info`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  url: infoUrl
                })
              });

              const result = await response.json();
              
              if (response.ok) {
                setVideoInfo(result);
              } else {
                alert('Error: ' + result.error);
                setVideoInfo(null);
              }
            } catch (error) {
              alert('Connection error: ' + error.message);
            }
            
            setIsProcessing(false);
          };

          const clearDownloads = async () => {
            try {
              const response = await fetch(`${API_BASE}/downloads/clear`, {
                method: 'POST'
              });
              
              if (response.ok) {
                const result = await response.json();
                console.log('Cleared downloads:', result.cleared_count);
              }
            } catch (error) {
              console.error('Failed to clear downloads:', error);
            }
          };

          const cancelDownload = async (downloadId) => {
            try {
              const response = await fetch(`${API_BASE}/downloads/${downloadId}`, {
                method: 'DELETE'
              });
              
              if (response.ok) {
                console.log('Download cancelled:', downloadId);
              } else {
                alert('Failed to cancel download');
              }
            } catch (error) {
              console.error('Failed to cancel download:', error);
            }
          };

          const refreshDownloads = () => {
            if (socket && socket.connected) {
              socket.emit('get_downloads');
              console.log('Refreshing downloads...');
            }
          };

          // Copy download link to clipboard
          const copyDownloadLink = async (downloadId) => {
            try {
              const downloadUrl = `${window.location.origin}/api/downloads/${downloadId}/file`;
              await navigator.clipboard.writeText(downloadUrl);
              alert('Download link copied to clipboard!');
            } catch (error) {
              console.error('Failed to copy link:', error);
              alert('Failed to copy link to clipboard');
            }
          };

          // Enhanced utility functions
          const getStatusIcon = (status) => {
            const icons = {
              'pending': '‚è≥',
              'queued': '‚è≥',
              'starting': 'üöÄ',
              'downloading': '‚¨áÔ∏è',
              'extracting': 'üîç',
              'extracting_links': 'üîó',
              'extracting_profile': 'üë§',
              'completed': '‚úÖ',
              'error': '‚ùå',
              'cancelled': '‚èπÔ∏è'
            };
            return icons[status] || '‚ùì';
          };

          const getStatusColor = (status) => {
            const colors = {
              'queued': 'bg-gray-100 text-gray-800',
              'starting': 'bg-blue-100 text-blue-800',
              'downloading': 'bg-yellow-100 text-yellow-800',
              'extracting': 'bg-purple-100 text-purple-800',
              'extracting_links': 'bg-purple-100 text-purple-800',
              'extracting_profile': 'bg-purple-100 text-purple-800',
              'completed': 'bg-green-100 text-green-800',
              'error': 'bg-red-100 text-red-800',
              'cancelled': 'bg-gray-100 text-gray-800'
            };
            return colors[status] || colors.queued;
          };

          const getPlatformColor = (platform) => {
            const colors = {
              tiktok: 'bg-pink-100 text-pink-800',
              youtube: 'bg-red-100 text-red-800',
              instagram: 'bg-purple-100 text-purple-800',
              facebook: 'bg-blue-100 text-blue-800',
              douyin: 'bg-indigo-100 text-indigo-800',
              webpage: 'bg-orange-100 text-orange-800',
              unknown: 'bg-gray-100 text-gray-800'
            };
            return colors[platform] || colors.unknown;
          };

          const formatBytes = (bytes) => {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
          };

          const formatSpeed = (speed) => {
            if (!speed) return '';
            return formatBytes(speed) + '/s';
          };

          const formatTime = (seconds) => {
            if (!seconds || seconds < 0) return '';
            if (seconds < 60) return `${Math.round(seconds)}s`;
            
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}m ${secs.toString().padStart(2, '0')}s`;
          };

          // Enhanced Download Item Component
          const DownloadItem = ({ download }) => {
            const [expanded, setExpanded] = useState(false);
            const [lastUpdate, setLastUpdate] = useState(download.last_update || Date.now());
            const [autoDownloaded, setAutoDownloaded] = useState(false);


              // Auto-download when video completes
                useEffect(() => {
                  if (download.status === 'completed' && download.filename && !autoDownloaded) {
                    // Trigger automatic download
                    const downloadUrl = `${API_BASE}/downloads/${download.id}/file`;
                    
                    // Create invisible link and click it
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = download.filename;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    setAutoDownloaded(true);
                    
                    // Show notification
                    if ('Notification' in window && Notification.permission === 'granted') {
                      new Notification('Download Complete', {
                        body: `${download.filename} has been downloaded automatically`,
                        icon: '/favicon.ico'
                      });
                    }
                  }
                }, [download.status, download.filename, download.id, autoDownloaded]);

                // Request notification permission on mount
                useEffect(() => {
                  if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission();
                  }
                }, []);
            
            // Auto-collapse after completion
            useEffect(() => {
              if (download.status === 'completed' && expanded) {
                const timer = setTimeout(() => setExpanded(false), 3000);
                return () => clearTimeout(timer);
              }
            }, [download.status, expanded]);

            // Update last seen time
            useEffect(() => {
              if (download.last_update && download.last_update > lastUpdate) {
                setLastUpdate(download.last_update);
              }
            }, [download.last_update]);
            
            const isActive = ['downloading', 'starting'].includes(download.status);
            const statusClass = `status-${download.status}`;
            
            return (
              <div className={`download-item border border-gray-200 rounded-lg p-3 hover:shadow-md transition-all ${statusClass} ${download.status === 'error' ? 'bg-red-50' : ''}`}>
                <div className="flex items-start justify-between mb-2">
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center space-x-2 mb-1">
                      <span className="text-lg" title={download.status}>
                        {getStatusIcon(download.status)}
                      </span>
                      <span className={`px-2 py-1 rounded text-xs font-medium ${getPlatformColor(download.platform)}`}>
                        {download.platform.toUpperCase()}
                      </span>
                      {download.batch_id && (
                        <span className="px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800">
                          Batch: {download.batch_current || download.batch_index}/{download.batch_total}
                        </span>
                      )}
                      {download.type && download.type !== 'single' && (
                        <span className="px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">
                          {download.type.toUpperCase()}
                        </span>
                      )}
                      {download.status === 'completed' && autoDownloaded && (
                        <span className="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
                          Auto-Downloaded
                        </span>
                      )}
                    </div>
                    
                    <p className="text-xs font-medium text-gray-900 truncate" title={download.url}>
                      {download.url}
                    </p>
                    
                    {download.filename && (
                      <p className="text-xs text-gray-500 truncate mt-1" title={download.filename}>
                        üìÅ {download.filename}
                      </p>
                    )}
                  </div>
                  
                  <div className="flex items-center space-x-2 ml-2">
                    {isActive && (
                      <button 
                        onClick={() => cancelDownload(download.id)}
                        className="text-gray-400 hover:text-red-500 transition-colors text-sm"
                        title="Cancel download"
                      >
                        ‚èπÔ∏è
                      </button>
                    )}
                    <button 
                      onClick={() => setExpanded(!expanded)}
                      className="text-gray-400 hover:text-blue-500 transition-colors text-sm"
                      title={expanded ? "Collapse details" : "Expand details"}
                    >
                      {expanded ? '‚ñ≤' : '‚ñº'}
                    </button>
                  </div>
                </div>
                
                {/* Enhanced Progress Bar */}
                {isActive && (
                  <div className="mb-2">
                    <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                      <div 
                        className={`bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-500 ${isActive ? 'progress-active' : ''}`}
                        style={{ width: `${download.percentage || download.progress || 0}%` }}
                      ></div>
                    </div>
                    <div className="flex justify-between text-xs text-gray-600 mt-1">
                      <span className="font-medium">{Math.round(download.percentage || download.progress || 0)}%</span>
                      <div className="flex space-x-3">
                        {download.downloaded_bytes > 0 && (
                          <span> {formatBytes(download.downloaded_bytes)}</span>
                        )}
                        {download.speed > 0 && (
                          <span> {formatSpeed(download.speed)}</span>
                        )}
                        {download.eta > 0 && (
                          <span> {formatTime(download.eta)}</span>
                        )}
                      </div>
                    </div>
                  </div>
                )}
                
                {/* Manual Download Section for Completed Videos (Backup) */}
                  {download.status === 'completed' && download.filename && (
                    <div className="mt-2 pt-2 border-t border-gray-200">
                      <div className="flex space-x-2">
                        <button
                          onClick={() => {
                            const link = document.createElement('a');
                            link.href = `${API_BASE}/downloads/${download.id}/file`;
                            link.download = download.filename;
                            link.click();
                          }}
                          className="flex-1 bg-gray-500 text-white text-sm py-2 px-3 rounded hover:bg-gray-600 transition-colors text-center font-medium"
                          title="Download again if auto-download failed"
                        >
                          Download Again
                        </button>
                        <button
                          onClick={() => copyDownloadLink(download.id)}
                          className="bg-blue-500 text-white text-sm py-2 px-3 rounded hover:bg-blue-600 transition-colors"
                          title="Copy download link"
                        >
                          üîó Copy Link
                        </button>
                      </div>
                    </div>
                  )}
                
                {/* Expanded Details */}
                {expanded && (
                  <div className="mt-2 pt-2 border-t border-gray-200 text-xs space-y-1">
                    <div className="grid grid-cols-2 gap-2">
                      <div>
                        <span className="font-medium">Status:</span>
                      </div>
                      <div>
                        <span className={`px-2 py-1 rounded ${getStatusColor(download.status)}`}>
                          {download.status.replace(/_/g, ' ')}
                        </span>
                      </div>
                      
                      {download.total_bytes > 0 && (
                        <>
                          <div>
                            <span className="font-medium">Size:</span>
                          </div>
                          <div>
                            <span>{formatBytes(download.total_bytes)}</span>
                          </div>
                        </>
                      )}
                      
                      <div>
                        <span className="font-medium">Started:</span>
                      </div>
                      <div>
                        <span>{new Date(download.created_at).toLocaleTimeString()}</span>
                      </div>
                      
                      {download.total_time && (
                        <>
                          <div>
                            <span className="font-medium">Duration:</span>
                          </div>
                          <div>
                            <span>{formatTime(download.total_time)}</span>
                          </div>
                        </>
                      )}
                    </div>
                    
                    {download.error && (
                      <div className="mt-2 p-2 bg-red-50 rounded border border-red-200">
                        <span className="font-medium text-red-800">Error:</span>
                        <p className="text-red-700 break-words">{download.error}</p>
                      </div>
                    )}
                  </div>
                )}
                
                {/* Status Summary */}
                <div className="flex items-center justify-between mt-2">
                  <span className="text-xs text-gray-500 capitalize font-medium">
                    {download.status.replace(/_/g, ' ')}
                  </span>
                  
                  {download.status === 'completed' && (
                    <span className="text-xs text-green-600 font-medium flex items-center">
                      <span className="mr-1"></span>
                      ‚ú®Done {download.total_time && `in ${formatTime(download.total_time)}`}
                    </span>
                  )}
                  
                  {download.status === 'error' && (
                    <span className="text-xs text-red-500 truncate max-w-32" title={download.error}>
                      ‚ùåFailed
                    </span>
                  )}
                </div>
              </div>
            );
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">
              <div className="container mx-auto px-4 py-8">
                {/* Header */}
                <div className="text-center mb-8">
                  <h1 className="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-4">
                    Fast Hand Video
                  </h1>
                  <p className="text-gray-600 text-lg">
                    Download videos from TikTok, YouTube, Instagram, Facebook, and more
                  </p>
                  <div className="mt-4 flex justify-center items-center space-x-3">
                    <div className={`connection-dot ${connectionStatus === 'connected' ? 'connection-connected' : 'connection-disconnected'}`}></div>
                    <span className={`text-sm font-medium ${connectionStatus === 'connected' ? 'text-green-600' : 'text-red-600'}`}>
                      {connectionStatus === 'connected' ? 'Connected' : 'Disconnected'}
                    </span>
                    {connectionStatus !== 'connected' && (
                      <button 
                        onClick={connectSocket}
                        className="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600"
                      >
                        Reconnect
                      </button>
                    )}
                  </div>
                </div>

                {/* Settings Panel */}
                <div className="bg-white rounded-xl shadow-lg p-6 mb-8 border border-gray-100">
                  <div className="flex items-center mb-4">
                    <span className="text-lg font-semibold">Settings</span>
                  </div>
                  
                  <div className="grid md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Download Directory
                      </label>
                      <input
                        type="text"
                        value={settings.download_path}
                        onChange={(e) => setSettings({...settings, download_path: e.target.value})}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="./downloads"
                      />
                    </div>
                  </div>
                </div>

                <div className="grid lg:grid-cols-3 gap-8">
                  {/* Main Panel */}
                  <div className="lg:col-span-2">
                    <div className="bg-white rounded-xl shadow-lg border border-gray-100">
                      {/* Tab Navigation */}
                      <div className="border-b border-gray-200">
                        <div className="flex flex-wrap">
                          {[
                            { id: 'single', label: 'Single Video', icon: 'Video' },
                            { id: 'batch', label: 'Batch Download', icon: 'Download' },
                            { id: 'profile', label: 'Profile', icon: 'User' },
                            { id: 'webpage', label: 'Webpage', icon: 'Link' },
                            { id: 'info', label: 'Video Info', icon: 'Info' }
                          ].map(({ id, label, icon }) => (
                            <button
                              key={id}
                              onClick={() => setActiveTab(id)}
                              className={`flex items-center space-x-2 px-4 py-3 text-sm font-medium border-b-2 transition-colors ${
                                activeTab === id
                                  ? 'border-blue-500 text-blue-600'
                                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                              }`}
                            >
                              <span>{label}</span>
                            </button>
                          ))}
                        </div>
                      </div>

                      {/* Tab Content */}
                      <div className="p-6">
                        {activeTab === 'single' && (
                          <div className="space-y-4">
                            <h3 className="text-lg font-semibold mb-4">Download Single Video</h3>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-2">
                                Video URL *
                              </label>
                              <input
                                type="url"
                                value={singleUrl}
                                onChange={(e) => setSingleUrl(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="https://www.tiktok.com/@user/video/..."
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-2">
                                Custom Filename (Optional)
                              </label>
                              <input
                                type="text"
                                value={customFilename}
                                onChange={(e) => setCustomFilename(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="my_video"
                              />
                            </div>
                            <button
                              onClick={handleSingleDownload}
                              disabled={!singleUrl.trim() || isProcessing || connectionStatus !== 'connected'}
                              className="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-4 rounded-lg hover:from-blue-600 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2 font-medium"
                            >
                              <span>{isProcessing ? 'Starting Download...' : 'Download Video'}</span>
                            </button>
                          </div>
                        )}

                        {activeTab === 'batch' && (
                          <div className="space-y-4">
                            <h3 className="text-lg font-semibold mb-4">Batch Download</h3>
                            
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-2">
                                Video URLs (One per line) *
                              </label>
                              <textarea
                                value={batchUrls}
                                onChange={(e) => setBatchUrls(e.target.value)}
                                rows={6}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="https://www.tiktok.com/@user/video/1&#10;https://www.youtube.com/watch?v=...&#10;https://www.instagram.com/p/..."
                              />
                            </div>
                            <button
                              onClick={handleBatchDownload}
                              disabled={!batchUrls.trim() || isProcessing || connectionStatus !== 'connected'}
                              className="w-full bg-gradient-to-r from-green-500 to-teal-600 text-white py-3 px-4 rounded-lg hover:from-green-600 hover:to-teal-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2 font-medium"
                            >
                              <span>{isProcessing ? 'Starting Batch...' : 'Download All Videos'}</span>
                            </button>
                          </div>
                        )}

                        {activeTab === 'profile' && (
                          <div className="space-y-4">
                            <h3 className="text-lg font-semibold mb-4">Download Profile Videos</h3>
                            
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-2">
                                Profile URL *
                              </label>
                              <input
                                type="url"
                                value={profileUrl}
                                onChange={(e) => setProfileUrl(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="https://www.tiktok.com/@username"
                              />
                            </div>

                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-2">
                                Max Videos (Optional)
                              </label>
                              <input
                                type="number"
                                value={maxVideos}
                                onChange={(e) => setMaxVideos(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Leave empty for all videos"
                                min="1"
                              />
                            </div>

                            <button
                              onClick={handleProfileDownload}
                              disabled={!profileUrl.trim() || isProcessing || connectionStatus !== 'connected'}
                              className="w-full bg-gradient-to-r from-purple-500 to-pink-600 text-white py-3 px-4 rounded-lg hover:from-purple-600 hover:to-pink-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2 font-medium"
                            >
                              <span>{isProcessing ? 'Starting Profile Download...' : 'Download Profile Videos'}</span>
                            </button>
                          </div>
                        )}

                        {activeTab === 'webpage' && (
                          <div className="space-y-4">
                            <h3 className="text-lg font-semibold mb-4">Extract Videos from Webpage</h3>
                            
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-2">
                                Webpage URL *
                              </label>
                              <input
                                type="url"
                                value={webpageUrl}
                                onChange={(e) => setWebpageUrl(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="https://example.com/page-with-videos"
                              />
                            </div>

                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-2">
                                Max Videos
                              </label>
                              <input
                                type="number"
                                value={maxWebpageVideos}
                                onChange={(e) => setMaxWebpageVideos(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="10"
                                min="1"
                                max="50"
                              />
                            </div>

                            <button
                              onClick={handleWebpageDownload}
                              disabled={!webpageUrl.trim() || isProcessing || connectionStatus !== 'connected'}
                              className="w-full bg-gradient-to-r from-orange-500 to-red-600 text-white py-3 px-4 rounded-lg hover:from-orange-600 hover:to-red-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2 font-medium"
                            >
                              <span>{isProcessing ? 'Starting Extraction...' : 'Extract & Download'}</span>
                            </button>
                          </div>
                        )}

                        {activeTab === 'info' && (
                          <div className="space-y-4">
                            <h3 className="text-lg font-semibold mb-4">Get Video Information</h3>
                            
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-2">
                                Video URL *
                              </label>
                              <input
                                type="url"
                                value={infoUrl}
                                onChange={(e) => setInfoUrl(e.target.value)}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="https://www.youtube.com/watch?v=..."
                              />
                            </div>

                            <button
                              onClick={handleGetVideoInfo}
                              disabled={!infoUrl.trim() || isProcessing || connectionStatus !== 'connected'}
                              className="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white py-3 px-4 rounded-lg hover:from-indigo-600 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center space-x-2 font-medium"
                            >
                              <span>{isProcessing ? 'Getting Info...' : 'Get Video Info'}</span>
                            </button>

                            {videoInfo && (
                              <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                                <h4 className="font-medium mb-2">Video Information:</h4>
                                <div className="space-y-1 text-sm">
                                  <p><span className="font-medium">Title:</span> {videoInfo.title}</p>
                                  <p><span className="font-medium">Platform:</span> 
                                    <span className={`ml-2 px-2 py-1 rounded text-xs ${getPlatformColor(videoInfo.platform)}`}>
                                      {videoInfo.platform.toUpperCase()}
                                    </span>
                                  </p>
                                  <p><span className="font-medium">Uploader:</span> {videoInfo.uploader}</p>
                                  <p><span className="font-medium">Duration:</span> {formatTime(videoInfo.duration)}</p>
                                  <p><span className="font-medium">Views:</span> {videoInfo.view_count?.toLocaleString()}</p>
                                </div>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>

                  {/* Enhanced Downloads Sidebar */}
                  <div className="lg:col-span-1">
                    <div className="bg-white rounded-xl shadow-lg border border-gray-100 sticky top-4">
                      <div className="p-4 border-b border-gray-200 flex items-center justify-between">
                        <h3 className="text-lg font-semibold">
                          Downloads ({downloads.length})
                          {downloads.filter(d => ['downloading', 'starting'].includes(d.status)).length > 0 && (
                            <span className="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                              {downloads.filter(d => ['downloading', 'starting'].includes(d.status)).length} active
                            </span>
                          )}
                        </h3>
                        <div className="flex space-x-2">
                          {/* Download All ZIP button */}
                          {downloads.filter(d => d.status === 'completed').length > 0 && (
                            <a
                              href={`${API_BASE}/downloads/all/zip`}
                              download="downloaded_videos.zip"
                              className="text-green-600 hover:text-green-800 transition-colors text-sm bg-green-50 px-2 py-1 rounded"
                              title="Download all videos as ZIP"
                            >
                              ZIP
                            </a>
                          )}
                          {downloads.length > 0 && (
                            <button
                              onClick={clearDownloads}
                              className="text-gray-400 hover:text-red-500 transition-colors"
                              title="Clear completed downloads"
                            >
                              Clear
                            </button>
                          )}
                          <button
                            onClick={refreshDownloads}
                            className="text-gray-400 hover:text-blue-500 transition-colors"
                            title="Refresh downloads"
                          >
                            Refresh
                          </button>
                        </div>
                      </div>
                      
                      <div className="p-4 max-h-96 overflow-y-auto download-scroll">
                        {downloads.length === 0 ? (
                          <div className="text-center py-8">
                            <div className="text-6xl mb-4">üì±</div>
                            <p className="text-gray-500 text-sm">No downloads yet</p>
                            <p className="text-gray-400 text-xs mt-2">
                              Start by entering a video URL above
                            </p>
                          </div>
                        ) : (
                          <div className="space-y-3">
                            {downloads
                              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                              .map((download) => (
                              <DownloadItem key={download.id} download={download} />
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>

                {/* Help/Tips Panel */}
                <div className="mt-8 bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                  <h3 className="text-lg font-semibold mb-4">Tips & Supported Platforms</h3>
                  <div className="grid md:grid-cols-2 gap-6">
                    <div>
                      <h4 className="font-medium mb-2 text-blue-600">Supported Platforms</h4>
                      <ul className="space-y-2 text-sm">
                        <li className="flex items-center">
                          <span className="w-5 h-5 mr-2 bg-pink-100 text-pink-800 rounded-full flex items-center justify-center text-xs">‚úì</span>
                          TikTok
                        </li>
                        <li className="flex items-center">
                          <span className="w-5 h-5 mr-2 bg-red-100 text-red-800 rounded-full flex items-center justify-center text-xs">‚úì</span>
                          YouTube
                        </li>
                        <li className="flex items-center">
                          <span className="w-5 h-5 mr-2 bg-purple-100 text-purple-800 rounded-full flex items-center justify-center text-xs">‚úì</span>
                          Instagram
                        </li>
                        <li className="flex items-center">
                          <span className="w-5 h-5 mr-2 bg-blue-100 text-blue-800 rounded-full flex items-center justify-center text-xs">‚úì</span>
                          Facebook
                        </li>
                        <li className="flex items-center">
                          <span className="w-5 h-5 mr-2 bg-indigo-100 text-indigo-800 rounded-full flex items-center justify-center text-xs">‚úì</span>
                          Douyin
                        </li>
                      </ul>
                    </div>
                    <div>
                      <h4 className="font-medium mb-2 text-purple-600">How to Download</h4>
                      <ul className="space-y-2 text-sm text-gray-600">
                        <li>‚Ä¢ Copy the exact URL from the platform's share button</li>
                        <li>‚Ä¢ Click the green "Download Video" button when completed</li>
                        <li>‚Ä¢ Use "ZIP" button to download all videos at once</li>
                        <li>‚Ä¢ Use batch download for multiple videos</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          );
        };
        
        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<VideoDownloaderUI />);
    </script>
</body>
</html>